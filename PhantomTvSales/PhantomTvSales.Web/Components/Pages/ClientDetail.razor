@page "/clients/{Id:int}"
@using System.Net.Http.Json
@using System.Globalization
@using System.Net.Http.Headers
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Nav

<h3>Detalle cliente</h3>

@if (!string.IsNullOrWhiteSpace(Msg))
{
  <div class="alert alert-info">@Msg</div>
}
@if (!string.IsNullOrWhiteSpace(Error))
{
  <div class="alert alert-danger">@Error</div>
}

@if (Loading)
{
  <p>Cargando…</p>
}
else if (Client is null)
{
  <div class="alert alert-warning">No encontrado</div>
}
else
{
  <div class="mb-3">
    <button class="btn btn-outline-secondary" @onclick='() => Nav.NavigateTo("/clients")'>← Volver</button>

  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="fw-bold fs-5">@Client.LastName, @Client.FirstName</div>
      <div class="text-muted">ID Phantom: @Client.PhantomId</div>
      <div><b>Tel:</b> @Client.Phone</div>
      <div><b>Dir:</b> @Client.Address</div>
      <div><b>Ciudad:</b> @Client.City</div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5>Estado de contacto</h5>

      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label">Estado</label>
          <select class="form-select" @bind="NewStatus">
            <option value="1">Contactado, a la espera de respuesta</option>
            <option value="2">Contactado y cerrada la venta</option>
            <option value="3">Contactado y no quiere el servicio</option>
            <option value="4">Contactado, servicio luego</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Notas</label>
          <textarea class="form-control" rows="3" @bind="Notes"></textarea>
        </div>

        <div class="col-12">
          <button class="btn btn-primary" @onclick="SaveStatus">Guardar estado</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5>Registrar venta (monto + PDF)</h5>
      <p class="text-muted mb-2">Usar solo si el estado es “Contactado y cerrada la venta”.</p>
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <label class="form-label">Monto</label>
          <input class="form-control" type="number" step="0.01" @bind="Amount" />
        </div>

        <div class="col-12 col-md-8">
          <label class="form-label">Comprobante (PDF)</label>
          <InputFile OnChange="OnFileChange" />
          @if (!string.IsNullOrWhiteSpace(SelectedFileName))
          {
            <div class="text-muted mt-1">@SelectedFileName</div>
          }
        </div>

        <div class="col-12">
          <button class="btn btn-success" @onclick="UploadSale" disabled="@(!IsSaleReady)">Guardar venta</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5>Última venta registrada</h5>
      @if (Client.Sale is null)
      {
        <p class="text-muted mb-0">Todavía no hay ventas registradas.</p>
      }
      else
      {
        <div><b>Monto:</b> @Client.Sale.Amount.ToString("N2")</div>
        <div><b>Fecha:</b> @Client.Sale.SoldAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
        <a class="btn btn-outline-primary btn-sm mt-2" href="@ReceiptUrl" target="_blank" rel="noopener noreferrer">
          Descargar comprobante
        </a>

      }
    </div>
  </div>
}

@code {

  string ReceiptUrl =>
  new Uri(HttpClientFactory.CreateClient("Api").BaseAddress!,
  $"api/clients/{Id}/sale/receipt").ToString();

  [Parameter] public int Id { get; set; }

  bool Loading = true;
  string? Error;
  string? Msg;

  ClientDto? Client;

  int NewStatus = 1;
  string? Notes;

  decimal Amount;
  IBrowserFile? ReceiptFile;
  string? SelectedFileName;
  bool IsSaleReady => NewStatus == 2 && ReceiptFile is not null && Amount > 0;

  protected override async Task OnInitializedAsync()
  {
    await Load();
  }

  async Task Load()
  {
    Loading = true;
    Error = null;
    Msg = null;

    try
    {
      var http = HttpClientFactory.CreateClient("Api");
      Client = await http.GetFromJsonAsync<ClientDto>($"/api/clients/{Id}");
      if (Client is not null)
      {
        NewStatus = Client.ContactStatus ?? 1;
        Notes = Client.Notes;
        ReceiptUrl = new Uri(http.BaseAddress!, $"api/clients/{Id}/sale/receipt").ToString();
      }
    }
    catch (Exception ex)
    {
      Error = ex.Message;
    }
    finally
    {
      Loading = false;
    }
  }

  async Task SaveStatus()
  {
    Error = null; Msg = null;
    try
    {
      var http = HttpClientFactory.CreateClient("Api");
      var res = await http.PutAsJsonAsync($"/api/clients/{Id}/status", new { status = NewStatus, notes = Notes });
      res.EnsureSuccessStatusCode();
      Msg = "Estado guardado.";
      await Load();
    }
    catch (Exception ex)
    {
      Error = ex.Message;
    }
  }

  void OnFileChange(InputFileChangeEventArgs e)
  {
    ReceiptFile = e.File;
    SelectedFileName = ReceiptFile?.Name;
  }

  async Task UploadSale()
  {
    Error = null; Msg = null;
    try
    {
      if (ReceiptFile is null) { Error = "Falta el PDF."; return; }
      if (!ReceiptFile.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
      {
        Error = "El comprobante debe ser PDF.";
        return;
      }

      var http = HttpClientFactory.CreateClient("Api");

      var content = new MultipartFormDataContent();
      content.Add(new StringContent(Amount.ToString(CultureInfo.InvariantCulture)), "amount");

      var stream = ReceiptFile.OpenReadStream(maxAllowedSize: 20_000_000);
      var fileContent = new StreamContent(stream);
      fileContent.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");

      content.Add(fileContent, "receiptPdf", ReceiptFile.Name);

      var res = await http.PostAsync($"/api/clients/{Id}/sale", content);
      res.EnsureSuccessStatusCode();

      Msg = "Venta guardada correctamente.";
      ReceiptFile = null;
      SelectedFileName = null;
      await Load();
    }
    catch (Exception ex)
    {
      Error = ex.Message;
    }
  }

  sealed class ClientDto
  {
    public int Id { get; set; }
    public string PhantomId { get; set; } = "";
    public string FirstName { get; set; } = "";
    public string LastName { get; set; } = "";
    public string Phone { get; set; } = "";
    public string Address { get; set; } = "";
    public string City { get; set; } = "";
    public int? ContactStatus { get; set; }
    public string? Notes { get; set; }
    public SaleDto? Sale { get; set; }
  }

  sealed class SaleDto
  {
    public int Id { get; set; }
    public decimal Amount { get; set; }
    public DateTime SoldAt { get; set; }
  }
}